# Задание: Автоматический поиск новостей

**Цель:** Реализовать интерфейс для автоматического поиска новостей из источников через LLM API с отображением прогресса и результатов.

**Стек:** React / Next.js, TailwindCSS (или используемый в проекте UI-фреймворк).

---

## 1. Общее описание функционала

Система автоматически ищет новости из списка источников через LLM API (OpenAI GPT-4o и Google Gemini), создает суммаризированные новости и сохраняет их как черновики для дальнейшего редактирования администратором.

### Основные возможности:
- Запуск поиска новостей для всех источников одним кликом
- Отображение прогресса поиска в реальном времени
- Показ результатов поиска (количество созданных новостей, ошибок)
- Просмотр созданных новостей-черновиков
- Возможность проверки источников по ссылкам в новостях

---

## 2. Страницы и компоненты

### 2.1. Страница списка источников (`/admin/resources` или `/resources`)

**Требования:**
- Добавить кнопку "Найти новости" в верхней части страницы (рядом с другими действиями)
- Кнопка должна быть доступна только для администраторов (`is_staff: true`)
- При клике открывается модальное окно или страница подтверждения

### 2.2. Страница/Модальное окно запуска поиска (`/admin/resources/discover`)

**Информация для отображения:**
- Дата последнего поиска
- Период поиска (с [дата] по [сегодня])
- Общее количество источников для обработки
- Кнопка "Начать поиск" (Start Search)
- Кнопка "Отмена" (Cancel)

**После запуска поиска:**
- Скрыть форму подтверждения
- Показать индикатор прогресса
- Отображать обновления в реальном времени

### 2.3. Индикатор прогресса

**Элементы:**
- Прогресс-бар (0-100%)
- Текст: "Обработано X из Y источников (Z%)"
- Статус: "Выполняется..." / "Завершено" / "Ошибка"

**Обновление:**
- Опрос статуса каждые 2-3 секунды через API
- Плавное обновление прогресс-бара
- Обновление текста с количеством обработанных источников

### 2.4. Страница результатов поиска

**Отображаемая информация:**
- Статус завершения (успешно / с ошибками)
- Количество созданных новостей
- Количество ошибок
- Общее количество обработанных источников
- Кнопка "Вернуться к источникам"
- Кнопка "Просмотреть новости" (переход к списку новостей)

---

## 3. API Specification

### 3.1. Запуск поиска новостей

**Endpoint:** `POST /admin/references/newsresource/discover-news/`

**Headers:**
```
Content-Type: application/json
X-Requested-With: XMLHttpRequest
Authorization: Bearer <access_token>
```

**Request Body:**
```json
{}
```

**Response (200 OK) - Начальный статус:**
```json
{
  "status": "running",
  "processed": 0,
  "total": 137,
  "percent": 0
}
```

**Response (200 OK) - После завершения:**
```json
{
  "status": "completed",
  "created": 45,
  "errors": 2,
  "total_processed": 137
}
```

**Response (500) - Ошибка:**
```json
{
  "status": "error",
  "message": "Описание ошибки"
}
```

**Примечания:**
- Запрос запускает поиск в фоновом режиме
- Сразу возвращает начальный статус
- Для получения финальных результатов нужно опрашивать endpoint статуса

---

### 3.2. Получение статуса поиска

**Endpoint:** `GET /admin/references/newsresource/discover-news-status/`

**Headers:**
```
Authorization: Bearer <access_token>
X-Requested-With: XMLHttpRequest
```

**Response (200 OK) - В процессе:**
```json
{
  "processed": 45,
  "total": 137,
  "status": "running",
  "percent": 33
}
```

**Response (200 OK) - Завершено:**
```json
{
  "processed": 137,
  "total": 137,
  "status": "completed",
  "percent": 100
}
```

**Response (200 OK) - Ошибка:**
```json
{
  "processed": 50,
  "total": 137,
  "status": "error",
  "percent": 36
}
```

**Response (200 OK) - Нет активного поиска:**
```json
{
  "processed": 0,
  "total": 0,
  "status": "none",
  "percent": 0
}
```

**Примечания:**
- Опрашивать каждые 2-3 секунды пока `status === "running"`
- При `status === "completed"` или `status === "error"` прекратить опрос
- При `status === "none"` показать, что поиск не запущен

---

### 3.3. Получение информации о периоде поиска

**Endpoint:** `GET /admin/references/newsresource/discover-news/`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200 OK):**
```html
<!-- HTML страница с формой подтверждения -->
<!-- Или можно использовать JSON API если будет реализован -->
```

**Альтернативный подход:**
Можно получить информацию о последнем поиске через отдельный endpoint или использовать данные из ответа статуса.

---

## 4. Структура данных новостей

### 4.1. Модель NewsPost

**Поля:**
- `id` (integer) - ID новости
- `title` (string) - Заголовок новости
- `body` (string) - Текст новости (Markdown формат)
- `source_url` (string, nullable) - URL оригинального источника новости (всегда заполнено для автоматически созданных новостей)
- `status` (string) - Статус: `"draft"`, `"scheduled"`, `"published"`
- `source_language` (string) - Исходный язык: `"ru"`, `"en"`, `"de"`, `"pt"`
- `pub_date` (datetime) - Дата публикации
- `created_at` (datetime) - Дата создания
- `updated_at` (datetime) - Дата обновления
- `author` (object, nullable) - Автор новости (объект с полями `id`, `email`, `first_name`, `last_name`)

**Важно:**
- Все новости, созданные автоматическим поиском, имеют статус `"draft"`
- Поле `source_url` всегда заполнено (даже для новостей "новостей не найдено" и ошибок)
- В тексте новости (`body`) в начале всегда есть ссылка на источник в формате Markdown: `**Источник для проверки:** [Название](URL)`

---

## 5. Требования к UI/UX

### 5.1. Кнопка запуска поиска

**Расположение:**
- В верхней части страницы списка источников
- Рядом с другими действиями (если есть)
- Выделена визуально (primary button)

**Состояния:**
- Обычное: "Найти новости"
- При активном поиске: "Поиск выполняется..." (disabled)
- После завершения: снова "Найти новости"

### 5.2. Модальное окно / Страница подтверждения

**Дизайн:**
- Четкая структура информации
- Выделение важных данных (дата последнего поиска, период)
- Кнопки действий внизу

**Информация:**
- Заголовок: "Поиск новостей"
- Дата последнего поиска: [дата]
- Период поиска: с [дата] по [сегодня]
- Количество источников: [число]

### 5.3. Индикатор прогресса

**Визуальные элементы:**
- Прогресс-бар с анимацией заполнения
- Процент выполнения (крупным шрифтом)
- Текст с количеством обработанных источников
- Иконка загрузки (spinner) при активном поиске

**Стили:**
- Прогресс-бар: цвет primary (синий/зеленый)
- Текст прогресса: информационный стиль
- При ошибке: красный цвет, иконка ошибки

### 5.4. Страница результатов

**Элементы:**
- Заголовок: "Результаты поиска новостей"
- Карточки/блоки с метриками:
  - Создано новостей (зеленый)
  - Ошибок (красный, если есть)
  - Обработано источников (информационный)
- Список последних созданных новостей (опционально)
- Кнопки действий

**Уведомления:**
- Успешное завершение: зеленое уведомление
- Ошибки: желтое/красное уведомление с описанием

---

## 6. Обработка ошибок

### 6.1. Ошибки API

**Сценарии:**
- Ошибка при запуске поиска (500)
- Ошибка при опросе статуса (network error, 500)
- Таймаут запроса

**Действия:**
- Показать сообщение об ошибке
- Предложить повторить попытку
- Сохранить текущий прогресс (если был)

### 6.2. Ошибки авторизации

**Сценарии:**
- Токен истек (401)
- Нет прав доступа (403)

**Действия:**
- Обновить токен автоматически (если возможно)
- Редирект на страницу входа
- Показать сообщение о необходимости авторизации

---

## 7. Интеграция с существующими страницами

### 7.1. Страница списка новостей

**Требования:**
- Добавить фильтр по статусу `draft` для просмотра черновиков
- Отображать колонку `source_url` как кликабельную ссылку
- При клике на ссылку открывать в новой вкладке
- Показывать иконку/индикатор для автоматически созданных новостей (опционально)

### 7.2. Страница редактирования новости

**Требования:**
- Отображать поле `source_url` как кликабельную ссылку
- Показывать предупреждение, что новость создана автоматически (если нужно)
- Возможность редактирования всех полей
- Возможность изменения статуса на `published`

---

## 8. Технические детали

### 8.1. Опрос статуса

**Реализация:**
- Использовать `setInterval` или `setTimeout` с рекурсией
- Опрашивать каждые 2-3 секунды
- Останавливать опрос при `status !== "running"`
- Очищать интервал при размонтировании компонента

**Оптимизация:**
- Не опрашивать, если поиск не запущен
- Прекратить опрос при ошибке сети
- Экспоненциальная задержка при ошибках (опционально)

### 8.2. Управление состоянием

**Рекомендации:**
- Использовать состояние компонента или глобальный state manager
- Хранить текущий статус поиска
- Обновлять UI при изменении статуса

### 8.3. Обработка длительных операций

**Особенности:**
- Поиск может занимать длительное время (минуты)
- Пользователь может закрыть страницу
- При возврате на страницу - проверить статус и показать актуальное состояние

---

## 9. Чек-лист для проверки (QA)

### Функциональность:
- [ ] Кнопка "Найти новости" отображается только для администраторов
- [ ] При клике открывается модальное окно/страница с информацией о периоде поиска
- [ ] Запуск поиска работает корректно
- [ ] Индикатор прогресса отображается и обновляется в реальном времени
- [ ] Прогресс-бар плавно заполняется от 0% до 100%
- [ ] Текст с количеством обработанных источников обновляется корректно
- [ ] После завершения отображаются результаты поиска
- [ ] Кнопка "Просмотреть новости" ведет на страницу списка новостей
- [ ] Кнопка "Вернуться к источникам" возвращает на страницу источников

### Обработка ошибок:
- [ ] Ошибка при запуске поиска отображается пользователю
- [ ] Ошибка при опросе статуса обрабатывается корректно
- [ ] При ошибке авторизации происходит редирект на логин
- [ ] При таймауте показывается соответствующее сообщение

### Интеграция:
- [ ] В списке новостей отображается колонка `source_url` как ссылка
- [ ] Ссылка на источник открывается в новой вкладке
- [ ] Фильтр по статусу `draft` работает корректно
- [ ] На странице редактирования новости отображается `source_url`

### UX:
- [ ] Интерфейс интуитивно понятен
- [ ] Все действия имеют визуальную обратную связь
- [ ] Прогресс отображается четко и понятно
- [ ] Результаты поиска представлены в удобном формате
- [ ] Нет блокировки интерфейса во время поиска

---

## 10. Дополнительные требования

### 10.1. Доступность (Accessibility)

- Все интерактивные элементы должны быть доступны с клавиатуры
- Прогресс-бар должен иметь ARIA-атрибуты для screen readers
- Сообщения об ошибках должны быть понятны

### 10.2. Производительность

- Опрос статуса не должен перегружать сервер
- Интервал опроса: 2-3 секунды (не чаще)
- Очистка интервалов при размонтировании компонентов

### 10.3. Адаптивность

- Интерфейс должен работать на мобильных устройствах
- Прогресс-бар и результаты должны корректно отображаться на всех размерах экранов

---

## 11. Примечания

- Все новости создаются со статусом `draft` для ручного редактирования
- Система не проверяет дубликаты - администратор увидит их вручную
- При отсутствии новостей создается специальная новость "новостей не найдено"
- При ошибках API создаются новости об ошибках для отслеживания проблемных источников
- Все новости содержат ссылку на источник для ручной проверки администратором

---

## 12. Связанные API endpoints

### Существующие endpoints (для справки):

**Список новостей:**
- `GET /api/news/` - Получить список новостей
- `GET /api/news/?status=draft` - Получить черновики

**Детали новости:**
- `GET /api/news/{id}/` - Получить детали новости
- `PATCH /api/news/{id}/` - Обновить новость
- `PUT /api/news/{id}/` - Полное обновление новости

**Список источников:**
- `GET /api/references/resources/` - Получить список источников

---

**Дата создания:** 18.12.2025  
**Версия:** 1.0
