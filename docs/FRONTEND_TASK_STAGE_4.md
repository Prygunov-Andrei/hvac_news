# Задание для Фронтенда - Этап 4: Социальные функции и Обратная связь

## Обзор
Этап 4 добавляет функциональность комментариев к новостям и форму обратной связи с защитой CAPTCHA.

---

## 1. Комментарии к новостям

### 1.1. API Endpoints

#### Получить список комментариев
```
GET /api/comments/
GET /api/comments/?news_post=<news_id>
```
**Параметры:**
- `news_post` (опционально) - ID новости для фильтрации

**Ответ:**
```json
{
  "count": 10,
  "next": "http://api.example.com/api/comments/?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "news_post": 5,
      "author": {
        "id": 2,
        "email": "user@example.com",
        "first_name": "John"
      },
      "text": "Отличная новость!",
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

#### Создать комментарий
```
POST /api/comments/
```
**Требуется авторизация:** Да (JWT токен)

**Тело запроса:**
```json
{
  "news_post": 5,
  "text": "Мой комментарий"
}
```

**Ответ:** `201 Created`
```json
{
  "id": 1,
  "news_post": 5,
  "author": {
    "id": 2,
    "email": "user@example.com",
    "first_name": "John"
  },
  "text": "Мой комментарий",
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

#### Обновить комментарий
```
PATCH /api/comments/<comment_id>/
PUT /api/comments/<comment_id>/
```
**Требуется авторизация:** Да (JWT токен)
**Права:** Только автор комментария или администратор

**Тело запроса:**
```json
{
  "text": "Обновленный текст комментария"
}
```

**Ответ:** `200 OK` (обновленный объект комментария)

#### Удалить комментарий
```
DELETE /api/comments/<comment_id>/
```
**Требуется авторизация:** Да (JWT токен)
**Права:** Только автор комментария или администратор

**Ответ:** `204 No Content`

#### Получить комментарии конкретной новости (альтернативный endpoint)
```
GET /api/comments/by-news/<news_id>/
```
**Ответ:** Массив комментариев (без пагинации)

---

### 1.2. Задачи для фронтенда

1. **Блок комментариев под новостью:**
   - Отобразить список комментариев для конкретной новости
   - Сортировка: от новых к старым
   - Показывать автора, дату создания, текст
   - Если комментарий был отредактирован, показывать дату обновления

2. **Форма добавления комментария:**
   - Доступна только для авторизованных пользователей
   - Поле ввода текста (максимум 2000 символов)
   - Кнопка "Отправить"
   - После отправки комментарий должен появиться в списке (без перезагрузки страницы)

3. **Редактирование комментария:**
   - Кнопка "Редактировать" видна только у своих комментариев
   - При клике открывается форма редактирования (inline или модальное окно)
   - Сохранение изменений через PATCH запрос

4. **Удаление комментария:**
   - Кнопка "Удалить" видна только у своих комментариев
   - Подтверждение удаления (confirm dialog)
   - После удаления комментарий исчезает из списка

5. **Обработка ошибок:**
   - Показывать ошибки валидации (например, пустой текст)
   - Показывать ошибки доступа (403) при попытке редактировать/удалить чужой комментарий

---

## 2. Форма обратной связи

### 2.1. API Endpoint

#### Отправить обратную связь
```
POST /api/feedback/
```
**Требуется авторизация:** Нет (доступно всем)

**Тело запроса:**
```json
{
  "email": "user@example.com",
  "name": "Иван Иванов",
  "message": "Текст сообщения",
  "captcha": "hcaptcha_token_или_recaptcha_token"
}
```

**Ответ при успехе:** `201 Created`
```json
{
  "message": "Thank you for your feedback! We will contact you soon.",
  "id": 1
}
```

**Ответ при ошибке:** `400 Bad Request`
```json
{
  "captcha": ["CAPTCHA verification failed. Please try again."]
}
```
или
```json
{
  "email": ["This field is required."],
  "message": ["This field is required."]
}
```

---

### 2.2. Задачи для фронтенда

1. **Страница/Модальное окно "Написать нам":**
   - Поле "Email" (обязательное, валидация email)
   - Поле "Имя" (опциональное)
   - Поле "Сообщение" (обязательное, textarea, максимум 2000 символов)
   - CAPTCHA виджет (hCaptcha или ReCaptcha)
   - Кнопка "Отправить"

2. **Интеграция CAPTCHA:**
   - Подключить hCaptcha или Google ReCaptcha
   - Получить токен после прохождения CAPTCHA
   - Отправить токен в поле `captcha` вместе с формой

3. **Обработка ответа:**
   - При успехе: показать сообщение "Спасибо за ваше сообщение!"
   - При ошибке CAPTCHA: показать ошибку и предложить пройти CAPTCHA заново
   - При других ошибках: показать соответствующие сообщения

4. **Валидация на фронтенде:**
   - Проверка обязательных полей
   - Валидация формата email
   - Проверка длины сообщения
   - Проверка, что CAPTCHA пройдена

---

## 3. Примеры использования

### 3.1. Создание комментария (JavaScript/TypeScript)

```typescript
const createComment = async (newsId: number, text: string, token: string) => {
  const response = await fetch('https://api.example.com/api/comments/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      news_post: newsId,
      text: text
    })
  });
  
  if (!response.ok) {
    throw new Error('Failed to create comment');
  }
  
  return await response.json();
};
```

### 3.2. Получение комментариев новости

```typescript
const getComments = async (newsId: number) => {
  const response = await fetch(
    `https://api.example.com/api/comments/?news_post=${newsId}`
  );
  
  return await response.json();
};
```

### 3.3. Отправка обратной связи с hCaptcha

```typescript
const submitFeedback = async (
  email: string,
  name: string,
  message: string,
  captchaToken: string
) => {
  const response = await fetch('https://api.example.com/api/feedback/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      email,
      name,
      message,
      captcha: captchaToken
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.captcha?.[0] || 'Failed to submit feedback');
  }
  
  return await response.json();
};
```

---

## 4. Чек-лист тестирования

### Комментарии:
- [ ] Незарегистрированный пользователь видит комментарии, но не видит форму ввода
- [ ] Авторизованный пользователь может создать комментарий
- [ ] После создания комментарий появляется в списке без перезагрузки
- [ ] Кнопки "Редактировать" и "Удалить" видны только у своих комментариев
- [ ] Редактирование комментария работает корректно
- [ ] Удаление комментария работает с подтверждением
- [ ] Попытка редактировать/удалить чужой комментарий возвращает ошибку 403
- [ ] Комментарии отображаются в правильном порядке (новые сверху)

### Обратная связь:
- [ ] Форма доступна всем пользователям (включая анонимных)
- [ ] Валидация полей работает на фронтенде
- [ ] CAPTCHA интегрирована и работает
- [ ] Форма не отправляется без прохождения CAPTCHA
- [ ] При успешной отправке показывается сообщение об успехе
- [ ] При ошибке CAPTCHA показывается соответствующее сообщение
- [ ] При других ошибках показываются понятные сообщения

---

## 5. Дополнительные замечания

1. **Авторизация:** Для работы с комментариями требуется JWT токен в заголовке `Authorization: Bearer <token>`

2. **CAPTCHA:** 
   - Поддерживаются hCaptcha и Google ReCaptcha
   - Тип CAPTCHA настраивается на бэкенде через переменную окружения `CAPTCHA_TYPE`
   - В режиме разработки (DEBUG=True) CAPTCHA проверка может быть отключена

3. **Email:** 
   - Email администратору отправляется автоматически при создании обратной связи
   - Настройки SMTP настраиваются через переменные окружения (см. документацию бэкенда)

4. **Обработка ошибок:**
   - Все ошибки возвращаются в формате JSON с описанием проблемы
   - Коды статусов: 400 (Bad Request), 401 (Unauthorized), 403 (Forbidden), 201 (Created), 200 (OK), 204 (No Content)

