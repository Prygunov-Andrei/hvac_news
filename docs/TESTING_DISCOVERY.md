# Инструкция по тестированию функционала поиска новостей

## Подготовка

1. Убедитесь, что установлены все зависимости:
```bash
pip install -r requirements.txt
```

2. Убедитесь, что настроены API ключи в `.env` или `settings.py`:
- `TRANSLATION_API_KEY` - ключ OpenAI
- `GEMINI_API_KEY` - ключ Google Gemini

3. Примените миграции:
```bash
python manage.py migrate
```

## Тестирование через Management команду

### Тестирование одного ресурса

```bash
python manage.py test_discovery
```

Команда автоматически:
- Выберет первый доступный ресурс из базы данных
- Запустит поиск новостей для этого ресурса
- Покажет результаты
- Установит дату последнего поиска на 08.12.2025

### Тестирование конкретного ресурса

```bash
python manage.py test_discovery --resource-id 1
```

Где `1` - это ID ресурса из базы данных.

### Установка другой даты

```bash
python manage.py test_discovery --set-date 2025-12-08
```

## Тестирование через админ-интерфейс

1. Войдите в админ-панель Django
2. Перейдите в раздел "News Resources"
3. Нажмите кнопку "Найти новости"
4. На странице подтверждения нажмите "Start Search"
5. Наблюдайте за прогрессом в реальном времени
6. После завершения проверьте созданные новости в разделе "News Posts"

## Что проверяется

1. **Подключение к API:**
   - OpenAI GPT-4o
   - Google Gemini 3 Pro

2. **Формирование промпта:**
   - Корректность временного интервала
   - Инструкции о поиске новостей
   - Требование суммаризации

3. **Обработка ответов:**
   - Парсинг JSON ответов
   - Объединение ответов от двух API
   - Финальная суммаризация

4. **Создание новостей:**
   - Создание новостей со статусом `draft`
   - Заполнение всех языков (ru, en, de, pt)
   - Сохранение `source_url`
   - Создание новостей "новостей нет" при отсутствии результатов
   - Создание новостей об ошибках при проблемах с API

5. **Индикатор прогресса:**
   - Обновление статуса в реальном времени
   - Корректное отображение прогресса

## Ожидаемые результаты

После успешного тестирования:
- В базе данных должны появиться новые записи в таблице `news_newspost` со статусом `draft`
- Дата последнего поиска должна быть установлена на указанную дату (по умолчанию 08.12.2025)
- В админ-панели должны быть видны созданные новости

## Устранение проблем

### Ошибка "API key is not set"
- Проверьте наличие ключей в настройках
- Убедитесь, что переменные окружения загружены

### Ошибка "Module not found"
- Установите зависимости: `pip install -r requirements.txt`

### Ошибка "Invalid JSON response"
- Проверьте логи для деталей
- Возможно, API вернул неожиданный формат

### Таймауты
- По умолчанию таймаут установлен на 120 секунд
- Можно изменить через переменную окружения `NEWS_DISCOVERY_TIMEOUT`
