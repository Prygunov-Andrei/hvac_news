# Реализация интеграции Grok (xAI) для поиска новостей

## Дата внедрения: 2025-12-18

## Что было сделано

### 1. Настройки в `config/settings.py`

Добавлены следующие настройки:
- `XAI_API_KEY` - API ключ для xAI (установлен по умолчанию)
- `NEWS_DISCOVERY_GROK_MODEL` - модель Grok (по умолчанию: `grok-4-1-fast`)
- `NEWS_DISCOVERY_USE_GROK` - флаг использования Grok (по умолчанию: `True`)
- `NEWS_DISCOVERY_USE_OPENAI_FALLBACK` - флаг использования OpenAI как резервного варианта (по умолчанию: `True`)

### 2. Обновлен `news/discovery_service.py`

**Изменения в `__init__`:**
- Добавлена поддержка Grok API ключа и модели
- Добавлены флаги для переключения между провайдерами

**Новый метод `_query_grok()`:**
- Использует OpenAI-совместимый API xAI через `base_url="https://api.x.ai/v1"`
- Автоматически использует веб-поиск (Grok имеет встроенную поддержку)
- Парсит JSON ответы с обработкой различных форматов
- Обрабатывает ошибки и возвращает структурированные данные

**Обновлен метод `discover_news_for_resource()`:**
- Сначала пытается использовать Grok (если включен)
- При ошибке Grok автоматически переключается на OpenAI (если включен fallback)
- Логирует какой провайдер был использован

### 3. Обновлен `requirements.txt`

- Добавлен комментарий о том, что xai-sdk не требуется (требует Python >= 3.10)
- Используется OpenAI SDK для работы с xAI API (OpenAI-совместимый формат)

## Как это работает

1. **Приоритет провайдеров:**
   - Если `NEWS_DISCOVERY_USE_GROK=True` и есть API ключ → используется Grok
   - При ошибке Grok → автоматически переключается на OpenAI (если `NEWS_DISCOVERY_USE_OPENAI_FALLBACK=True`)
   - Если Grok отключен → используется только OpenAI

2. **Веб-поиск:**
   - Grok автоматически использует веб-поиск при необходимости
   - Не требуется явное указание tools (в отличие от OpenAI Responses API)

3. **Формат ответа:**
   - Grok возвращает JSON в том же формате, что и OpenAI
   - Обработка ответов унифицирована для обоих провайдеров

## Переменные окружения

Для настройки через `.env` файл:

```env
# Grok (xAI) Configuration
XAI_API_KEY=your-xai-api-key-here
NEWS_DISCOVERY_GROK_MODEL=grok-4-1-fast
NEWS_DISCOVERY_USE_GROK=True
NEWS_DISCOVERY_USE_OPENAI_FALLBACK=True
```

## Тестирование

Для тестирования интеграции:

1. Убедитесь, что API ключ установлен
2. Запустите поиск новостей через админ-панель или management command
3. Проверьте логи - должен быть указан используемый провайдер (Grok или OpenAI)

## Преимущества

- ✅ **Скорость:** Grok оптимизирован для быстрых ответов
- ✅ **Простота:** Не нужен специальный Responses API
- ✅ **Надежность:** Автоматический fallback на OpenAI при ошибках
- ✅ **Совместимость:** Использует стандартный OpenAI SDK

## Примечания

- Python версия: 3.9 (xai-sdk требует >= 3.10, поэтому используется OpenAI SDK)
- API формат: OpenAI-совместимый через `base_url="https://api.x.ai/v1"`
- Веб-поиск: Автоматический, не требует явного указания tools

## Следующие шаги

1. Протестировать на реальных источниках
2. Сравнить скорость и качество результатов Grok vs OpenAI
3. При необходимости настроить параметры модели или промпты
4. Мониторить использование и стоимость API
