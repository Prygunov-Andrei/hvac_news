# Этап 5: Загрузка новостей через веб-интерфейс

## Общее описание

Реализация функционала для создания и редактирования новостей через веб-интерфейс с WYSIWYG-редактором и автоматическим переводом через LLM.

**Основные возможности:**
- Админ создаёт новости через удобный редактор (как в Word)
- Поддержка форматирования, изображений, видео, ссылок
- Автоматический перевод на все языки через LLM
- Черновики и отложенная публикация
- Редактирование и удаление опубликованных новостей

---

## Этап 5.1: CRUD API для новостей (Админ)

### Описание
Расширяем существующий `NewsPostViewSet` с Read-Only до полноценного CRUD. Добавляем права доступа: создавать, редактировать и удалять новости могут только администраторы (is_staff=True). Обычные пользователи по-прежнему только читают.

### Backend задачи
1. Изменить `NewsPostViewSet`:
   - Добавить методы `create`, `update`, `partial_update`, `destroy`
   - Реализовать permission class `IsAdminUser` для write-операций
2. Создать `NewsPostWriteSerializer`:
   - Поля: `title`, `body`, `pub_date`, `author` (auto from request.user)
   - Валидация: title обязателен, body обязателен
3. Добавить endpoint для получения одной новости по ID (уже есть в ViewSet)
4. Реализовать soft-delete или hard-delete (на выбор)

### API Endpoints

| Метод | URL | Описание | Права |
|-------|-----|----------|-------|
| `GET` | `/api/news/` | Список новостей | Все |
| `GET` | `/api/news/<id>/` | Детали новости | Все |
| `POST` | `/api/news/` | Создать новость | Admin |
| `PATCH` | `/api/news/<id>/` | Редактировать | Admin |
| `DELETE` | `/api/news/<id>/` | Удалить | Admin |

### Тесты
- [ ] Админ может создать новость через API
- [ ] Обычный пользователь получает 403 при попытке создать новость
- [ ] Админ может редактировать существующую новость
- [ ] Админ может удалить новость
- [ ] После удаления новость не появляется в списке

---

## Этап 5.2: Загрузка медиафайлов

### Описание
Реализуем отдельный endpoint для загрузки изображений и видео. Фронтенд будет загружать файл, получать URL, и вставлять его в текст редактора. Файлы сохраняются в `/media/news/uploads/<year>/<month>/`.

### Backend задачи
1. Создать модель `MediaUpload`:
   - Поля: `file`, `media_type` (image/video), `uploaded_by`, `created_at`
2. Создать `MediaUploadSerializer` и `MediaUploadViewSet`
3. Настроить ограничения:
   - Максимальный размер файла (10MB для изображений, 100MB для видео)
   - Допустимые форматы: jpg, png, gif, webp, mp4, webm
4. Возвращать полный URL загруженного файла

### API Endpoints

| Метод | URL | Описание | Права |
|-------|-----|----------|-------|
| `POST` | `/api/media/upload/` | Загрузить файл | Admin |
| `GET` | `/api/media/<id>/` | Получить инфо о файле | Admin |
| `DELETE` | `/api/media/<id>/` | Удалить файл | Admin |

### Тесты
- [ ] Админ может загрузить изображение и получить URL
- [ ] Админ может загрузить видео и получить URL
- [ ] Загрузка файла недопустимого формата возвращает 400
- [ ] Загрузка файла больше лимита возвращает 400
- [ ] Обычный пользователь не может загружать файлы

---

## Этап 5.3: Интеграция LLM для автоперевода

### Описание
При создании/редактировании новости админ вводит текст на одном языке (определяется автоматически или выбирается). При сохранении система отправляет запрос к LLM API (OpenAI/Anthropic/DeepL) для перевода на остальные языки (RU, EN, DE, PT).

### Backend задачи
1. Создать сервис `TranslationService`:
   - Метод `translate(text, source_lang, target_lang) -> str`
   - Метод `translate_news(title, body, source_lang) -> dict` (возвращает переводы на все языки)
2. Добавить настройки в `settings.py`:
   - `TRANSLATION_API_KEY` (env variable)
   - `TRANSLATION_PROVIDER` ('openai', 'anthropic', 'deepl')
3. Интегрировать в `NewsPostViewSet.create()` и `update()`:
   - Определить исходный язык
   - Вызвать перевод
   - Сохранить переводы в соответствующие поля (`title_ru`, `title_en`, и т.д.)
4. Добавить поле `source_language` в модель `NewsPost`
5. Реализовать асинхронный перевод (Celery) или синхронный (для MVP)

### API Endpoints

| Метод | URL | Описание | Права |
|-------|-----|----------|-------|
| `POST` | `/api/news/` | Создать + автоперевод | Admin |
| `POST` | `/api/translate/preview/` | Превью перевода (опционально) | Admin |

### Payload для создания новости

```json
{
  "title": "Samsung покупает FläktGroup",
  "body": "<p>Текст новости...</p>",
  "source_language": "ru",
  "pub_date": "2025-12-04T14:00:00Z",
  "auto_translate": true
}
```

### Тесты
- [ ] Перевод текста с RU на EN работает корректно
- [ ] При создании новости с `auto_translate=true` заполняются все языковые поля
- [ ] При `auto_translate=false` переводы не выполняются
- [ ] Ошибка API перевода не блокирует создание новости (fallback)
- [ ] HTML-разметка сохраняется после перевода

---

## Этап 5.4: Отложенная публикация и черновики

### Описание
Админ может сохранить новость как черновик или запланировать публикацию на будущую дату. Новости со статусом "черновик" или с `pub_date` в будущем не отображаются в публичном API.

### Backend задачи
1. Добавить поле `status` в модель `NewsPost`:
   - Значения: `draft`, `scheduled`, `published`
2. Обновить `get_queryset()` в `NewsPostViewSet`:
   - Публичный API: только `status=published` и `pub_date <= now`
   - Админский API: все записи
3. Добавить Celery task для автопубликации:
   - Каждую минуту проверять `status=scheduled` и `pub_date <= now`
   - Менять статус на `published`
4. Добавить endpoint для получения черновиков админа

### API Endpoints

| Метод | URL | Описание | Права |
|-------|-----|----------|-------|
| `GET` | `/api/news/` | Опубликованные новости | Все |
| `GET` | `/api/news/drafts/` | Черновики | Admin |
| `GET` | `/api/news/scheduled/` | Запланированные | Admin |
| `POST` | `/api/news/<id>/publish/` | Опубликовать сейчас | Admin |

### Payload для создания

```json
{
  "title": "Заголовок",
  "body": "<p>Текст</p>",
  "status": "scheduled",
  "pub_date": "2025-12-25T10:00:00Z"
}
```

### Тесты
- [ ] Черновик не появляется в публичном API
- [ ] Запланированная новость не появляется до наступления `pub_date`
- [ ] Celery task переводит `scheduled` → `published` в нужное время
- [ ] Админ видит все свои черновики через `/api/news/drafts/`
- [ ] Ручная публикация через `/api/news/<id>/publish/` работает

---

## Сводка этапов

| Этап | Название | Зависимости | Статус |
|------|----------|-------------|--------|
| 5.1 | CRUD API для новостей | — | ✅ Завершен |
| 5.2 | Загрузка медиафайлов | 5.1 | ✅ Завершен |
| 5.3 | Интеграция LLM для перевода | 5.1 | ✅ Завершен |
| 5.4 | Отложенная публикация | 5.1 | ✅ Завершен |

**Статус:** Все этапы завершены и протестированы.

---

## Технические детали

### База данных
- **Используется:** PostgreSQL
- **Имя базы данных:** `hvac_db` (настраивается через переменную окружения `DB_NAME`)
- **Настройки:** Через переменные окружения в `.env` файле:
  ```
  DB_ENGINE=django.db.backends.postgresql
  DB_NAME=hvac_db
  DB_USER=postgres
  DB_PASSWORD=postgres
  DB_HOST=localhost
  DB_PORT=5432
  ```

### Рефакторинг
- Выполнен полный рефакторинг кодовой базы
- Устранены N+1 проблемы с запросами к БД
- Удален неиспользуемый код
- Устранено дублирование функций
- Оптимизированы ViewSets и сериализаторы

---

## Задание для фронтенда (после завершения бекенда)

### Компоненты
1. **Кнопка "Создать новость"** в левом меню (только для админов)
2. **WYSIWYG редактор** (TipTap / Quill / Editor.js):
   - Панель инструментов: жирный, курсив, заголовки, списки
   - Вставка изображений (загрузка через API)
   - Вставка видео (загрузка через API)
   - Вставка ссылок
3. **Форма публикации**:
   - Выбор исходного языка
   - Дата/время публикации или "Опубликовать сейчас"
   - Кнопки: "Сохранить черновик", "Опубликовать"
4. **Список черновиков** для админа
5. **Редактирование** существующих новостей
6. **Удаление** новостей с подтверждением

