# Анализ подходов к накоплению статистики и ранжированию источников новостей

## Дата анализа: 2025-01-07

## Цель

Накопление статистики по источникам новостей для:
- Ранжирования источников по продуктивности
- Выявления наиболее активных источников
- Выявления неактивных источников
- Оптимизации процесса поиска (приоритизация источников)
- Аналитики и отчетности

---

## Варианты подходов

### Вариант 1: Модель статистики с агрегацией (Рекомендуется)

**Идея:** Создать отдельную модель `NewsResourceStatistics` для хранения накопленной статистики по каждому источнику.

**Структура модели:**
```python
class NewsResourceStatistics(models.Model):
    resource = models.OneToOneField(NewsResource, on_delete=models.CASCADE, related_name='statistics')
    
    # Общая статистика
    total_news_found = models.IntegerField(default=0)  # Всего найдено новостей за все время
    total_searches = models.IntegerField(default=0)  # Всего поисков
    total_no_news = models.IntegerField(default=0)  # Всего раз "не найдено"
    total_errors = models.IntegerField(default=0)  # Всего ошибок
    
    # Временные метрики
    last_search_date = models.DateTimeField(null=True, blank=True)  # Дата последнего поиска
    last_news_date = models.DateTimeField(null=True, blank=True)  # Дата последней найденной новости
    first_search_date = models.DateTimeField(null=True, blank=True)  # Дата первого поиска
    
    # Процентные метрики
    success_rate = models.FloatField(default=0.0)  # Процент успешных поисков (найдено новостей)
    error_rate = models.FloatField(default=0.0)  # Процент ошибок
    
    # Средние значения
    avg_news_per_search = models.FloatField(default=0.0)  # Среднее количество новостей за поиск
    
    # Периодическая статистика (за последние 30/90 дней)
    news_last_30_days = models.IntegerField(default=0)
    news_last_90_days = models.IntegerField(default=0)
    searches_last_30_days = models.IntegerField(default=0)
    
    # Рейтинг и приоритет
    ranking_score = models.FloatField(default=0.0)  # Общий рейтинг для сортировки
    priority = models.IntegerField(default=0)  # Приоритет обработки (чем выше, тем раньше обрабатывать)
    
    updated_at = models.DateTimeField(auto_now=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Преимущества:**
- ✅ Быстрый доступ к статистике (не нужно агрегировать каждый раз)
- ✅ Можно обновлять инкрементально (при каждом поиске)
- ✅ Легко ранжировать и сортировать
- ✅ Можно добавить индексы для быстрой сортировки
- ✅ Гибкость в добавлении новых метрик

**Недостатки:**
- ⚠️ Нужно поддерживать синхронизацию с реальными данными
- ⚠️ Дополнительная таблица в БД

**Обновление статистики:**
- При каждом поиске обновлять счетчики
- Пересчитывать проценты и средние значения
- Обновлять рейтинг

---

### Вариант 2: Агрегация на лету из NewsPost

**Идея:** Вычислять статистику динамически из таблицы `NewsPost` при запросе.

**Методы:**
```python
# В модели NewsResource добавить методы:
def get_total_news_count(self):
    return NewsPost.objects.filter(source_url__icontains=self.url).count()

def get_no_news_count(self):
    return NewsPost.objects.filter(
        source_url__icontains=self.url,
        is_no_news_found=True
    ).count()

def get_success_rate(self):
    total = self.get_total_news_count()
    no_news = self.get_no_news_count()
    return (total - no_news) / total * 100 if total > 0 else 0
```

**Преимущества:**
- ✅ Всегда актуальные данные
- ✅ Не нужно синхронизировать
- ✅ Не занимает дополнительное место в БД

**Недостатки:**
- ⚠️ Медленнее при большом количестве новостей
- ⚠️ Сложнее делать сложные запросы (топ-10, ранжирование)
- ⚠️ Нет истории изменений

---

### Вариант 3: Гибридный подход (Рекомендуется для продакшена)

**Идея:** Комбинация обоих подходов:
- Модель статистики для быстрого доступа и ранжирования
- Возможность пересчета из NewsPost для проверки актуальности
- Периодический фоновый процесс для синхронизации

**Реализация:**
- Обновлять статистику при каждом поиске (инкрементально)
- Раз в день/неделю пересчитывать из NewsPost для проверки
- Метод `recalculate_statistics()` для полного пересчета

---

## Метрики для ранжирования

### Базовые метрики

1. **Общее количество найденных новостей** (`total_news_found`)
   - Простая метрика, показывает общую продуктивность

2. **Процент успешных поисков** (`success_rate`)
   - `(total_searches - total_no_news - total_errors) / total_searches * 100`
   - Показывает надежность источника

3. **Среднее количество новостей за поиск** (`avg_news_per_search`)
   - `total_news_found / total_searches`
   - Показывает продуктивность одного поиска

4. **Активность за последние 30/90 дней** (`news_last_30_days`)
   - Показывает текущую активность источника

### Составной рейтинг (ranking_score)

**Формула для расчета:**
```
ranking_score = 
    (total_news_found * 0.3) +                    # Общая продуктивность (30%)
    (success_rate * 0.2) +                        # Надежность (20%)
    (avg_news_per_search * 10 * 0.2) +           # Продуктивность поиска (20%)
    (news_last_30_days * 0.3)                    # Текущая активность (30%)
```

Или более сложная формула с весами:
```
ranking_score = 
    (total_news_found / max_total_news * 100 * 0.25) +
    (success_rate * 0.25) +
    (avg_news_per_search / max_avg_news * 100 * 0.25) +
    (news_last_30_days / max_30d_news * 100 * 0.25)
```

### Приоритет обработки

**Логика:**
- Высокий приоритет: источники с высоким `ranking_score` и недавней активностью
- Средний приоритет: источники со средним рейтингом
- Низкий приоритет: источники с низким рейтингом или давно неактивные

**Можно добавить:**
- `is_active` - флаг активности (автоматически обновляется)
- `last_activity_days` - дней с последней активности

---

## Где и как обновлять статистику

### Место обновления

**В методе `discover_news_for_resource()`:**
- После успешного поиска обновлять статистику
- Увеличивать счетчики
- Пересчитывать проценты и средние

**Пример:**
```python
def discover_news_for_resource(self, resource: NewsResource):
    # ... существующий код поиска ...
    
    # После создания новостей обновляем статистику
    if created_count > 0 or error_count > 0:
        self._update_resource_statistics(
            resource, 
            created_count, 
            error_count, 
            has_news=(created_count > 0 and not is_no_news)
        )
```

### Метод обновления статистики

```python
def _update_resource_statistics(self, resource, news_count, error_count, has_news):
    """Обновляет статистику источника после поиска"""
    stats, created = NewsResourceStatistics.objects.get_or_create(
        resource=resource
    )
    
    stats.total_searches += 1
    stats.last_search_date = timezone.now()
    
    if error_count > 0:
        stats.total_errors += error_count
    elif has_news:
        stats.total_news_found += news_count
        stats.last_news_date = timezone.now()
    else:
        stats.total_no_news += 1
    
    # Пересчитываем метрики
    stats.success_rate = ((stats.total_searches - stats.total_no_news - stats.total_errors) 
                         / stats.total_searches * 100) if stats.total_searches > 0 else 0
    
    stats.avg_news_per_search = (stats.total_news_found / stats.total_searches 
                                 if stats.total_searches > 0 else 0)
    
    # Пересчитываем рейтинг
    stats.ranking_score = self._calculate_ranking_score(stats)
    
    stats.save()
```

---

## Использование статистики

### 1. Ранжирование в админ-панели

**В `NewsResourceAdmin`:**
- Добавить колонки: `total_news_found`, `success_rate`, `ranking_score`
- Добавить сортировку по рейтингу
- Добавить фильтры: активные/неактивные, высокий/низкий рейтинг

### 2. Приоритизация при поиске

**В `discover_all_news()`:**
- Сортировать источники по `priority` или `ranking_score`
- Сначала обрабатывать наиболее продуктивные источники
- Менее активные источники обрабатывать реже

### 3. API для фронтенда

**Эндпоинт:** `GET /api/resources/?ordering=ranking_score`
- Возвращать источники с их статистикой
- Возможность фильтрации и сортировки
- Показывать топ-10, топ-20 источников

### 4. Дашборд/аналитика

- Графики активности источников
- Топ-10 самых продуктивных источников
- Источники, требующие внимания (много ошибок, низкая активность)

---

## Дополнительные идеи

### 1. История изменений

**Модель `NewsResourceStatisticsHistory`:**
- Сохранять снимки статистики раз в день/неделю
- Позволяет строить графики изменения активности
- Анализ трендов

### 2. Категоризация источников

**Автоматические категории:**
- "Высокопродуктивные" - топ 20% по рейтингу
- "Средние" - средние 60%
- "Низкопродуктивные" - нижние 20%
- "Неактивные" - нет новостей за последние 90 дней
- "Проблемные" - высокий процент ошибок

### 3. Умная приоритизация

**Алгоритм:**
- Источники с высоким рейтингом обрабатывать чаще
- Источники с низким рейтингом - реже (раз в неделю/месяц)
- Проблемные источники - с задержкой или в конце очереди

### 4. Уведомления и алерты

- Уведомление, если источник не находил новости N дней подряд
- Уведомление при высоком проценте ошибок
- Уведомление о новых высокопродуктивных источниках

### 5. Интеграция с поиском

**В интерфейсе поиска:**
- Показывать рейтинг источника рядом с названием
- Цветовая индикация (зеленый - активный, красный - неактивный)
- Фильтр "Показать только активные источники"

---

## Рекомендуемый план реализации

### Этап 1: Базовая статистика
1. Создать модель `NewsResourceStatistics`
2. Добавить метод обновления статистики в `discovery_service.py`
3. Обновлять статистику при каждом поиске
4. Добавить базовые метрики: total_news, total_searches, success_rate

### Этап 2: Ранжирование
1. Добавить расчет `ranking_score`
2. Добавить поле `priority`
3. Обновить админ-панель для отображения статистики
4. Добавить сортировку по рейтингу

### Этап 3: Приоритизация поиска
1. Модифицировать `discover_all_news()` для сортировки по приоритету
2. Реализовать логику умной приоритизации
3. Тестирование на реальных данных

### Этап 4: API и фронтенд
1. Добавить статистику в `NewsResourceSerializer`
2. Создать эндпоинт для топ-источников
3. Интеграция с фронтендом (если нужно)

### Этап 5: Аналитика (опционально)
1. История изменений
2. Графики и дашборды
3. Уведомления

---

## Вопросы для уточнения

1. **Как часто обновлять статистику?**
   - При каждом поиске (рекомендуется)
   - Раз в день (фоновый процесс)
   - Комбинация обоих

2. **Нужна ли история изменений?**
   - Для графиков и трендов
   - Или достаточно текущей статистики

3. **Как использовать ранжирование?**
   - Только для отображения в админке
   - Для приоритизации при поиске
   - Для фильтрации источников

4. **Нужны ли уведомления?**
   - О неактивных источниках
   - О проблемных источниках
   - О новых активных источниках

5. **Интеграция с фронтендом?**
   - Показывать статистику в интерфейсе
   - Фильтры и сортировка
   - Дашборд с графиками

---

## Выводы

**Рекомендуемый подход:** Вариант 3 (Гибридный)
- Модель статистики для быстрого доступа
- Инкрементальное обновление при каждом поиске
- Возможность пересчета для проверки

**Приоритет метрик:**
1. Общее количество новостей (30%)
2. Текущая активность за 30 дней (30%)
3. Процент успешных поисков (20%)
4. Среднее количество новостей за поиск (20%)

**Следующие шаги:**
1. Создать модель `NewsResourceStatistics`
2. Интегрировать обновление статистики в процесс поиска
3. Добавить отображение в админ-панели
4. Реализовать ранжирование и приоритизацию
